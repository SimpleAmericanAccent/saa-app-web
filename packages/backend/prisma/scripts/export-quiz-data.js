import { PrismaClient } from "../generated/index.js";
import { writeFile } from "fs/promises";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const prisma = new PrismaClient();

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

/**
 * Export Contrast and Pair data from the database to a format suitable for seeding
 *
 * This script:
 * 1. Fetches all Contrast records
 * 2. Fetches all Pair records grouped by contrast
 * 3. Generates a JavaScript file with the data in the format expected by seed-quiz.js
 *
 * Run with: node prisma/scripts/export-quiz-data.js
 *
 * The output file will be written to: prisma/scripts/quiz-seed-data-exported.js
 *
 * You can then review and merge this into quiz-seed-data.js
 */
async function exportQuizData() {
  try {
    console.log("ğŸ“¥ Exporting quiz data from database...\n");

    // Fetch all contrasts
    console.log("ğŸ“ Fetching contrasts...");
    const contrasts = await prisma.contrast.findMany({
      orderBy: { key: "asc" },
    });
    console.log(`   Found ${contrasts.length} contrasts\n`);

    // Fetch all pairs grouped by contrast
    console.log("ğŸ“ Fetching pairs...");
    const allPairs = await prisma.pair.findMany({
      orderBy: [{ contrastId: "asc" }, { wordA: "asc" }, { wordB: "asc" }],
      include: {
        contrast: {
          select: {
            key: true,
          },
        },
      },
    });
    console.log(`   Found ${allPairs.length} pairs\n`);

    // Group pairs by contrast key
    const pairsByContrast = {};
    for (const pair of allPairs) {
      const contrastKey = pair.contrast.key;
      if (!pairsByContrast[contrastKey]) {
        pairsByContrast[contrastKey] = [];
      }
      pairsByContrast[contrastKey].push({
        contrastKey: contrastKey,
        wordA: pair.wordA,
        wordB: pair.wordB,
        alternateA: pair.alternateA || [],
        alternateB: pair.alternateB || [],
        audioAUrl: pair.audioAUrl,
        audioBUrl: pair.audioBUrl,
        active: pair.active,
      });
    }

    // Format contrasts for export
    const formattedContrasts = contrasts.map((c) => ({
      key: c.key,
      name: c.name,
      title: c.title,
      description: c.description,
      category: c.category,
      soundAName: c.soundAName,
      soundBName: c.soundBName,
      soundASymbol: c.soundASymbol,
      soundBSymbol: c.soundBSymbol,
      active: c.active,
    }));

    // Generate the export file
    const exportContent = `/**
 * Exported quiz seed data
 * 
 * Generated on: ${new Date().toISOString()}
 * 
 * This file was auto-generated by export-quiz-data.js
 * Review and merge the data below into quiz-seed-data.js
 */

export const contrasts = ${JSON.stringify(formattedContrasts, null, 2)};

export const pairsByContrast = ${JSON.stringify(pairsByContrast, null, 2)};
`;

    const outputPath = join(__dirname, "quiz-seed-data-exported.js");
    await writeFile(outputPath, exportContent, "utf-8");

    console.log("âœ… Export complete!");
    console.log(`   Output file: ${outputPath}\n`);
    console.log("ğŸ“‹ Next steps:");
    console.log("   1. Review the exported file");
    console.log("   2. Copy the data into quiz-seed-data.js");
    console.log("   3. Delete quiz-seed-data-exported.js if desired");
  } catch (error) {
    console.error("âŒ Error exporting quiz data:", error);
    throw error;
  } finally {
    await prisma.$disconnect();
  }
}

exportQuizData().catch((e) => {
  console.error("âŒ Fatal error:", e);
  process.exit(1);
});

